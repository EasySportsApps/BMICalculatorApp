---
title: "\\textbf{BMI report}"
output:
  pdf_document:
    latex_engine: pdflatex
    keep_tex: true
pagestyle: empty
fontsize: 10pt
header-includes:
  - \usepackage[T1]{fontenc}
  - \usepackage{helvet}
  - \renewcommand{\familydefault}{\sfdefault}
  - \pagenumbering{gobble}
params:
  date: NA
  person_id: NA
  sex: NA
  weight: NA
  height: NA
  bmi: NA
---

```{r setup, include=FALSE}
options(warn = -1)
```

\begin{itemize}
  \setlength\itemsep{5pt}
  \item \textbf{Person ID:} `r params$person_id`
  \item \textbf{Evaluation date:} `r format(params$date, "%Y-%m-%d %H:%M:%S")`
  \item \textbf{Sex:} `r params$sex`
  \item \textbf{Weight:} `r sprintf("%.1f", params$weight)` kg
  \item \textbf{Height:} `r sprintf("%.2f", params$height)` m
  \item \textbf{BMI:} `r sprintf("%.2f", params$bmi)` kg/m²
\end{itemize}

\vspace{1cm}

```{r echo=FALSE, fig.width=8, fig.height=5}
library(ggplot2)
library(ggtext)
m_range <- seq(0, 2.5, by = 0.01)

kg_min <- rep(0, length(m_range))
kg_max <- rep(250, length(m_range))

kg_uw <- pmin(pmax(m_range^2 * 18.5, 0), 250)
kg_n <- pmin(pmax(m_range^2 * 24.9, 0), 250)
kg_ow <- pmin(pmax(m_range^2 * 29.9, 0), 250)
kg_ob1 <- pmin(pmax(m_range^2 * 34.9, 0), 250)
kg_ob2 <- pmin(pmax(m_range^2 * 39.9, 0), 250)
kg_ob3 <- pmin(pmax(m_range^2 * 45, 0), 250)

df_zones <- data.frame(
  height = c(
    m_range, rev(m_range),
    m_range, rev(m_range),
    m_range, rev(m_range),
    m_range, rev(m_range),
    m_range, rev(m_range),
    m_range, rev(m_range)
  ),
  weight = c(
    kg_min, rev(kg_uw),
    kg_uw, rev(kg_n),
    kg_n, rev(kg_ow),
    kg_ow, rev(kg_ob1),
    kg_ob1, rev(kg_ob2),
    kg_ob2, rev(kg_max)
  ),
  zone = factor(rep(c("Underweight", "Normal", "Overweight", 
                      "Obesity I", "Obesity II", "Obesity III"),
                    each = length(m_range)*2),
                levels = c("Underweight", "Normal", "Overweight", 
                           "Obesity I", "Obesity II", "Obesity III"))
)

zone_colors <- c(
  "Underweight" = "lightblue",
  "Normal" = "palegreen3",
  "Overweight" = "salmon",
  "Obesity I" = "orange",
  "Obesity II" = "orangered",
  "Obesity III" = "red3"
)

label_formatter <- function(breaks) {
  function(x) {
    ifelse(x %in% c(min(breaks), max(breaks)), "", x)
  }
}

height_formatter <- function(breaks) {
  function(x) {
    labels <- ifelse(x %in% c(min(breaks), max(breaks)), "", sprintf("%.2f", x))
    labels
  }
}

x_breaks <- seq(0.1, 2.4, by = 0.1)
y_breaks <- seq(10, 240, by = 10)
y_axis_formatter <- function(x) { as.character(x) }
x_axis_formatter <- function(x) { sprintf("%.2f", x) }

p <- ggplot() +
  geom_polygon(data = df_zones, aes(x = height, y = weight, group = zone, fill = zone), alpha = 0.6) +
  scale_fill_manual(values = zone_colors, name = "BMI zone") +
  guides(fill = guide_legend(nrow = 1)) +
  coord_cartesian(xlim = c(0, 2.5), ylim = c(0, 250), expand = FALSE) +
  labs(x = "Height (m)", y = "Weight (kg)") +
  theme_classic() +
  theme(
    legend.title = element_text(size = 13),
    legend.text = element_text(size = 11),
    legend.position = "bottom",
    legend.key.width = unit(0.5, "cm"),
    legend.key.height = unit(0.5, "cm"),
    legend.key.spacing.y = unit(0.5, "cm"),
    axis.title.x = element_text(size = 13, margin = margin(t = 10, unit = "pt")),
    axis.title.y = element_text(size = 13, margin = margin(r = 10, unit = "pt")),
    axis.text = element_text(size = 8, color = "black"),
    axis.text.y = element_text(angle = 0, hjust = 1),
    axis.ticks = element_line(color = "black"),
    axis.ticks.length = unit(5, "pt"),
    axis.ticks.x.bottom = element_line(),
    axis.ticks.y.left = element_line()
  ) +
  scale_x_continuous(breaks = x_breaks, labels = x_axis_formatter) +
  scale_y_continuous(breaks = y_breaks, labels = y_axis_formatter)

kg_input <- params$weight
m_input <- params$height
id_input <- params$person_id
bmi_input <- params$bmi

if (!is.na(kg_input) && !is.na(m_input) && m_input > 0) {
  label_text_markdown <- paste0("ID: ", id_input, 
                                "\nBMI: ", sprintf("%.2f", bmi_input), " kg/m²")
  p <- p +
    geom_point(aes(x = m_input, y = kg_input), size = 2, shape = 21, 
               color = "black", fill = "white", stroke = 1.5) +
    annotate("text", x = m_input + 0.03, y = kg_input, 
             label = label_text_markdown,
             hjust = 0, vjust = 0.5, size = 4, lineheight = 1.0)
}

print(p)

```
